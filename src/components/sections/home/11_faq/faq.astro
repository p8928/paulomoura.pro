---
// src/components/sections/11_faq/faq.astro
import Button from '../../../ui/Button.astro';
import { promises as fs } from 'fs';
import path from 'path';

// Caminho para o arquivo de FAQ
const faqFilePath = path.join(process.cwd(), 'public', 'faq.txt');

// Ler o conteúdo do arquivo de forma assíncrona
const faqContent = await fs.readFile(faqFilePath, 'utf-8');

// Função para converter markdown simples em HTML
function formatAnswerContent(content) {
  // Tratar parágrafos (separados por linhas em branco)
  const paragraphs = content.split(/\n\s*\n/).map(p => {
    // Tratar negrito (**)
    p = p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // Tratar listas com marcadores (-)
    if (p.startsWith('- ')) {
      const listItems = p.split('\n').map(item => {
        if (item.startsWith('- ')) {
          return `<li class="faq-list-item">${item.substring(2).trim()}</li>`;
        }
        return item;
      }).join('');
      return `<ul class="faq-list">${listItems}</ul>`;
    }
    
    return `<p>${p.replace(/\n/g, '<br>')}</p>`;
  }).join('');
  
  return paragraphs;
}

// Processar o conteúdo da FAQ para extrair perguntas e respostas
function parseFAQ(content) {
  const lines = content.split('\n');
  const faqItems = [];
  let currentQuestion = '';
  let currentAnswer = '';

  for (const line of lines) {
    if (line.startsWith('## ')) {
      if (currentQuestion) {
        faqItems.push({
          question: currentQuestion,
          answer: formatAnswerContent(currentAnswer.trim())
        });
      }
      currentQuestion = line.substring(3).trim();
      currentAnswer = '';
    } else if (line.startsWith('# ')) {
      // Ignorar o título principal do arquivo
      continue;
    } else {
      currentAnswer += line + '\n';
    }
  }

  if (currentQuestion) {
    faqItems.push({
      question: currentQuestion,
      answer: formatAnswerContent(currentAnswer.trim())
    });
  }

  return faqItems;
}

const faqItems = parseFAQ(faqContent);
---

<div class="faq-section">
  <div class="faq-container">
    <h2 class="faq-title">Esclarecimentos</h2>
    <div class="faq-list">
      {
        faqItems.map((item) => (
          <div class="faq-item" data-animate="scroll">
            <button class="faq-question" type="button" aria-expanded="false">
              <span class="question-text">{item.question}</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="faq-answer">
              <div class="answer-content">
                <div set:html={item.answer}></div>
              </div>
            </div>
          </div>
        ))
      }
    </div>
    
    <div class="faq-cta-section">
      <Button href="/contato" variant="primary" class="faq-cta-button">
        Fale com especialista
        <span class="arrow">→</span>
      </Button>
    </div>
  </div>
</div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const faqItems = document.querySelectorAll('.faq-item');
    
    faqItems.forEach(item => {
      const button = item.querySelector('.faq-question');
      const answer = item.querySelector('.faq-answer');
      
      button.addEventListener('click', () => {
        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        // Se estiver abrindo uma nova resposta, feche todas as outras primeiro
        if (!isExpanded) {
          faqItems.forEach(otherItem => {
            if (otherItem !== item) {
              const otherButton = otherItem.querySelector('.faq-question');
              const otherAnswer = otherItem.querySelector('.faq-answer');
              const otherIcon = otherItem.querySelector('.faq-icon');

              otherButton.setAttribute('aria-expanded', 'false');
              otherAnswer.classList.remove('active');
              if (otherIcon) {
                otherIcon.style.transform = 'rotate(0deg)';
              }
            }
          });
        }
        
        // Alternar o estado do item clicado
        button.setAttribute('aria-expanded', String(!isExpanded));
        answer.classList.toggle('active');
        
        // Atualizar ícone
        const icon = button.querySelector('.faq-icon');
        if (icon) {
          icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      });
    });
    
    // Animação ao rolar
    const animateOnScroll = () => {
      const elements = document.querySelectorAll('[data-animate="scroll"]');
      
      elements.forEach(element => {
        const elementTop = element.getBoundingClientRect().top;
        const elementVisible = 150;
        
        if (elementTop < window.innerHeight - elementVisible) {
          element.classList.add('animate-in');
        }
      });
    };
    
    // Executar a animação ao carregar a página e ao rolar
    animateOnScroll();
    window.addEventListener('scroll', animateOnScroll);
  });
</script>

<style>
  .faq-section {
    padding: var(--space-4xl) var(--space-lg);
    background-color: var(--color-background);
    min-height: 100vh;
    display: flex;
    align-items: center;
  }

  .faq-container {
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  .faq-title {
    font-family: var(--font-family-heading);
    font-size: clamp(2rem, 4vw, 3.5rem);
    font-weight: var(--font-weight-light);
    line-height: var(--line-height-tight);
    color: var(--color-text-primary);
    margin: 0 0 1.5rem 0;
    letter-spacing: -0.05em;
    position: relative;
    text-align: center;
    padding-bottom: 1rem;
  }

  .faq-title::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: var(--color-accent);
    border-radius: 1px;
  }

  .faq-container h2 .highlight {
    color: var(--color-accent);
    position: relative;
  }

  .faq-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .faq-item {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    transition: var(--transition-normal);
  }

  .faq-item.animate-in {
    opacity: 1;
    transform: translateY(0);
  }

  .faq-question {
    width: 100%;
    padding: var(--space-lg);
    background: transparent;
    border: none;
    text-align: left;
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition-normal);
  }

  .faq-question:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }

  .faq-question:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .faq-icon {
    width: 24px;
    height: 24px;
    transition: var(--transition-normal);
    color: var(--color-accent);
  }

  .faq-answer {
    padding: 0 var(--space-lg);
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--transition-normal) ease-out;
    color: var(--color-text-secondary);
    line-height: var(--line-height-relaxed);
  }

  .faq-answer.active {
    max-height: var(--size-max-height);
    padding: 0 var(--space-lg) var(--space-lg) var(--space-lg);
  }

  .answer-content {
    padding: var(--space-md) 0 var(--space-sm) 0;
  }

  .answer-content p {
    margin-bottom: var(--space-md);
    line-height: var(--line-height-relaxed);
  }

  .answer-content strong {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
  }

  .answer-content ul, .answer-content ol {
    margin: var(--space-md) 0;
    padding-left: var(--space-lg);
  }

  .answer-content li {
    margin-bottom: var(--space-xs);
  }

  .faq-list-container {
    margin: var(--space-md) 0;
  }
  
  .faq-cta-section {
    text-align: center;
    margin-top: var(--space-4xl);
    margin-bottom: var(--space-xl);
  }
  
  .faq-cta-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-md) var(--space-2xl);
    background: transparent;
    color: var(--color-text-primary);
    border: 2px solid var(--color-primary);
    font-family: var(--font-family-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    white-space: nowrap;
    letter-spacing: var(--letter-spacing-wider);
    border-radius: 0;
    margin: 0 auto;
    max-width: 300px;
    position: relative;
    overflow: hidden;
  }

  .faq-cta-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--color-accent);
    transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: -1;
  }

  .faq-cta-button:hover::before {
    left: 0;
  }

  .faq-cta-button:hover {
    color: var(--color-primary);
    border-color: var(--color-accent);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(192, 178, 131, 0.3);
  }

  .arrow {
    margin-left: var(--space-sm);
    transition: transform 0.3s ease;
  }

  .faq-cta-button:hover .arrow {
    transform: translateX(5px);
  }

  @media (max-width: 768px) {
    .faq-section {
      padding: var(--space-3xl) var(--space-md);
      align-items: flex-start;
    }
    
    .faq-container h2 {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--space-2xl);
    }
    
    .faq-question {
      padding: var(--space-md);
      font-size: var(--font-size-base);
    }
  }

  @media (max-width: 480px) {
    .faq-section {
      padding: var(--space-2xl) var(--space-sm);
    }
    
    .faq-container h2 {
      font-size: var(--font-size-2xl);
    }
    
    .faq-question {
      padding: var(--space-sm);
    }
    
    .faq-answer {
      padding: 0 var(--space-sm);
    }
    
    .faq-answer.active {
      padding: 0 var(--space-sm) var(--space-md) var(--space-sm);
    }
  }
</style>
